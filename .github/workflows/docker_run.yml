name: Run Docker on Push or Pull Request

# Trigger the workflow on push or pull request to the model_local branch
on:
  push:
    branches:
      - model_local
  pull_request:
    branches:
      - model_local

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository code
      - name: Checkout code
        uses: actions/checkout@v2

      # Step 2: Set up Docker Buildx (optional, but useful for multi-platform support)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Step 3: Build the Docker image
      - name: Build Docker image
        run: |
          docker build -t my_model_pipeline -f ModelDevelopment/Dockerfile ModelDevelopment

      # Step 4: Run all scripts in a single Docker container and send notifications
      - name: Run scripts and send notifications
        env:
          SMTP_SERVER: "smtp.gmail.com"
          SMTP_PORT: "587"
          EMAIL_USERNAME: "anirudhak881@gmail.com"
          EMAIL_PASSWORD: "ksmhwqrzhjllqsaz"  # Make sure this is secure
          RECIPIENT_EMAIL: "anirudhak881@gmail.com"
        run: |
          # Run Training/Prophet.py
          docker run -d --name my_model_container my_model_pipeline python Training/Prophet.py
          docker wait my_model_container
          echo "Subject: GitHub Actions - Training/Prophet.py Completed" > email.txt
          echo "To: $RECIPIENT_EMAIL" >> email.txt
          echo "Training/Prophet.py has completed successfully." >> email.txt
          curl --url "smtp://$SMTP_SERVER:$SMTP_PORT" --ssl-reqd \
               --mail-from "$EMAIL_USERNAME" \
               --mail-rcpt "$RECIPIENT_EMAIL" \
               --upload-file email.txt \
               --user "$EMAIL_USERNAME:$EMAIL_PASSWORD"

          # Run Validation/Prophet.py in the same container
          docker exec my_model_container python Validation/Prophet.py
          echo "Subject: GitHub Actions - Validation/Prophet.py Completed" > email.txt
          echo "To: $RECIPIENT_EMAIL" >> email.txt
          echo "Validation/Prophet.py has completed successfully." >> email.txt
          curl --url "smtp://$SMTP_SERVER:$SMTP_PORT" --ssl-reqd \
               --mail-from "$EMAIL_USERNAME" \
               --mail-rcpt "$RECIPIENT_EMAIL" \
               --upload-file email.txt \
               --user "$EMAIL_USERNAME:$EMAIL_PASSWORD"

          # Run bestmodel.py in the same container
          docker exec my_model_container python bestmodel.py
          echo "Subject: GitHub Actions - bestmodel.py Completed" > email.txt
          echo "To: $RECIPIENT_EMAIL" >> email.txt
          echo "bestmodel.py has completed successfully." >> email.txt
          curl --url "smtp://$SMTP_SERVER:$SMTP_PORT" --ssl-reqd \
               --mail-from "$EMAIL_USERNAME" \
               --mail-rcpt "$RECIPIENT_EMAIL" \
               --upload-file email.txt \
               --user "$EMAIL_USERNAME:$EMAIL_PASSWORD"

          # Stop and remove the container after all scripts complete
          docker stop my_model_container
          docker rm my_model_container
